<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuizSpark</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ALL YOUR REACT CODE GOES HERE ---
        
        const { useState, useEffect, createContext, useContext, useMemo } = React;

        // --- MOCK DATABASE & API ---
        const mockData = {
          users: [
            { id: 1, name: 'Dr. Evelyn Reed', email: 'teacher@quizspark.com', password: 'password', role: 'teacher' },
            { id: 2, name: 'Alex Johnson', email: 'student@quizspark.com', password: 'password', role: 'student' },
            { id: 3, name: 'Ben Carter', email: 'student2@quizspark.com', password: 'password', role: 'student' },
          ],
          quizzes: [
            {
              id: 101,
              title: 'Introduction to Astrophysics',
              description: 'Test your knowledge of fundamental astrophysical concepts, from stars to galaxies.',
              time_limit: 30, // in minutes
              status: 'published',
              teacher_id: 1,
              questions: [
                {
                  id: 1001,
                  question_text: 'What is the most abundant element in the universe?',
                  media_type: 'none',
                  media_url: '',
                  options: [
                    { id: 1, text: 'Oxygen', is_correct: false },
                    { id: 2, text: 'Helium', is_correct: false },
                    { id: 3, text: 'Hydrogen', is_correct: true },
                    { id: 4, text: 'Carbon', is_correct: false },
                  ],
                },
                {
                  id: 1002,
                  question_text: 'Which of these is considered a dwarf planet?',
                  media_type: 'image',
                  media_url: 'https://placehold.co/600x400/0f172a/ffffff?text=Dwarf+Planet',
                  options: [
                    { id: 1, text: 'Mars', is_correct: false },
                    { id: 2, text: 'Jupiter', is_correct: false },
                    { id: 3, text: 'Pluto', is_correct: true },
                  ],
                },
                {
                  id: 1003,
                  question_text: 'Watch the video about black holes. What is the point of no return called?',
                  media_type: 'video',
                  media_url: 'https://www.youtube-nocookie.com/embed/e-P5IFTqB9c', // Example YouTube embed URL
                  options: [
                    { id: 1, text: 'Singularity', is_correct: false },
                    { id: 2, text: 'Event Horizon', is_correct: true },
                    { id: 3, text: 'Accretion Disk', is_correct: false },
                  ],
                },
              ],
            },
            {
              id: 102,
              title: 'World History: Ancient Civilizations',
              description: 'A quiz covering major ancient civilizations from Mesopotamia to Rome.',
              time_limit: 45,
              status: 'draft',
              teacher_id: 1,
              questions: [
                {
                  id: 2001,
                  question_text: 'In which ancient civilization was the pyramid of Giza built?',
                  media_type: 'none',
                  media_url: '',
                  options: [
                    { id: 1, text: 'Roman', is_correct: false },
                    { id: 2, text: 'Greek', is_correct: false },
                    { id: 3, text: 'Egyptian', is_correct: true },
                    { id: 4, text: 'Mesopotamian', is_correct: false },
                  ],
                }
              ],
            },
          ],
          submissions: [
              {
                id: 1,
                quiz_id: 101,
                student_id: 3,
                score: 2,
                start_time: new Date(Date.now() - 20 * 60 * 1000).toISOString(),
                end_time: new Date(Date.now() - 10 * 60 * 1000).toISOString(),
                answers: [
                    { question_id: 1001, selected_option_id: 3 }, // Correct
                    { question_id: 1002, selected_option_id: 1 }, // Incorrect
                    { question_id: 1003, selected_option_id: 2 }, // Correct
                ]
              }
          ],
        };

        // --- ICONS (INLINE SVGS) ---
        const PlusIcon = ({ className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 ${className}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>;
        const ArrowRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>;
        const CheckCircleIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const XCircleIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const BookOpenIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>;
        const ChartBarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
        const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a6 6 0 00-9-5.197" /></svg>;
        const ChevronUpIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>;

        // --- CONTEXT API FOR STATE MANAGEMENT ---
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
          const [user, setUser] = useState(null);
          const [role, setRole] = useState(null);
          const [quizzes, setQuizzes] = useState(mockData.quizzes);
          const [submissions, setSubmissions] = useState(mockData.submissions);
          const [page, setPage] = useState('role_selection'); // role_selection, login, teacher_dashboard, student_dashboard, etc.
          const [activeQuizId, setActiveQuizId] = useState(null);
          const [activeSubmissionId, setActiveSubmissionId] = useState(null);

          const login = (email, password, userRole) => {
            const foundUser = mockData.users.find(
              u => u.email === email && u.password === password && u.role === userRole
            );
            if (foundUser) {
              setUser(foundUser);
              setRole(foundUser.role);
              setPage(foundUser.role === 'teacher' ? 'teacher_dashboard' : 'student_dashboard');
              return true;
            }
            return false;
          };

          const logout = () => {
            setUser(null);
            setRole(null);
            setPage('role_selection');
          };

          const saveQuiz = (quizData) => {
            if (quizData.id) { // Editing existing quiz
              setQuizzes(quizzes.map(q => q.id === quizData.id ? quizData : q));
            } else { // Creating new quiz
              const newQuiz = { ...quizData, id: Date.now(), teacher_id: user.id, questions: [] };
              setQuizzes([...quizzes, newQuiz]);
            }
            setPage('teacher_dashboard');
          };
         
          const deleteQuiz = (quizId) => {
            setQuizzes(quizzes.filter(q => q.id !== quizId));
            // Also delete related submissions
            setSubmissions(submissions.filter(s => s.quiz_id !== quizId));
          };

          const startQuiz = (quizId) => {
            const newSubmission = {
              id: Date.now(),
              quiz_id: quizId,
              student_id: user.id,
              score: 0,
              start_time: new Date().toISOString(),
              end_time: null,
              answers: []
            };
            setSubmissions([...submissions, newSubmission]);
            setActiveSubmissionId(newSubmission.id);
            setActiveQuizId(quizId);
            setPage('quiz_taker');
          };
         
          const submitQuiz = (submissionId, answers) => {
            const submission = submissions.find(s => s.id === submissionId);
            const quiz = quizzes.find(q => q.id === submission.quiz_id);
            if (!submission || !quiz) return;
            
            let score = 0;
            answers.forEach(answer => {
              const question = quiz.questions.find(q => q.id === answer.question_id);
              if (question) {
                const correctOption = question.options.find(o => o.is_correct);
                if (correctOption && correctOption.id === answer.selected_option_id) {
                  score++;
                }
              }
            });

            const updatedSubmissions = submissions.map(s => 
              s.id === submissionId 
                ? { ...s, end_time: new Date().toISOString(), answers, score } 
                : s
            );
            setSubmissions(updatedSubmissions);
            setActiveSubmissionId(submissionId);
            setPage('quiz_results');
          };

          const viewPastResult = (submissionId) => {
            setActiveSubmissionId(submissionId);
            setPage('quiz_results');
          };

          const value = {
            user,
            role,
            quizzes,
            submissions,
            page,
            setPage,
            login,
            logout,
            saveQuiz,
            deleteQuiz,
            startQuiz,
            submitQuiz,
            viewPastResult,
            activeQuizId,
            setActiveQuizId,
            activeSubmissionId,
            setActiveSubmissionId,
            setQuizzes,
          };

          return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        // --- GENERIC UI COMPONENTS ---

        const Card = ({ children, className = '' }) => (
          <div className={`bg-black/20 backdrop-blur-2xl border border-white/10 rounded-xl shadow-2xl p-4 sm:p-6 transition-all duration-300 ${className}`}>
            {children}
          </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
          const baseClasses = 'px-4 py-2 sm:px-6 sm:py-3 font-bold rounded-xl transition-all duration-200 transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-950 backdrop-blur-sm';
          const variants = {
            primary: 'bg-green-400/80 text-green-950 border border-green-400/60 hover:bg-green-400/90 focus:ring-green-400',
            secondary: 'bg-white/10 text-white border border-white/20 hover:bg-white/20 focus:ring-white',
            danger: 'bg-red-500/70 text-white border border-red-500/50 hover:bg-red-500/80 focus:ring-red-500',
          };
          const disabledClasses = 'disabled:bg-white/5 disabled:text-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:border-white/10';
          const enabledClasses = 'hover:scale-105 active:scale-100';

          return (
            <button type={type} onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${disabled ? disabledClasses : enabledClasses} ${className}`}>
              {children}
            </button>
          );
        };

        const Input = ({ name, type = 'text', placeholder, value, onChange, className = '' }) => (
          <input
            name={name}
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            className={`w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 ${className}`}
          />
        );

        const Header = () => {
          const { user, logout, page } = useContext(AppContext);

          if (page === 'role_selection' || page.startsWith('login')) return null;

          return (
            <header className="bg-black/30 backdrop-blur-lg border-b border-white/10 sticky top-0 z-10">
              <div className="container mx-auto px-4 md:px-8 py-3 sm:py-4 flex justify-between items-center">
                <h1 className="text-2xl md:text-3xl font-bold text-white tracking-wider">Quiz<span className="text-green-400">Spark</span></h1>
                {user && (
                  <div className="flex items-center space-x-2 md:space-x-4">
                    <span className="text-gray-300 hidden sm:block">Welcome, {user.name}</span>
                    <Button onClick={logout} variant="secondary" className="py-2 px-3 md:px-6">Logout</Button>
                  </div>
                )}
              </div>
            </header>
          );
        };

        const RoleSelectionPage = () => {
            const { setPage } = useContext(AppContext);
            return (
                <div className="flex-grow flex items-center justify-center p-4">
                    <Card className="text-center w-full max-w-md">
                        <h2 className="text-3xl font-bold text-white mb-8">Welcome to QuizSpark</h2>
                        <p className="text-gray-400 mb-8">Please select your role to continue.</p>
                        <div className="space-y-4">
                            <Button onClick={() => setPage('login_teacher')} className="w-full text-lg">I am a Teacher</Button>
                            <Button onClick={() => setPage('login_student')} className="w-full text-lg" variant="secondary">I am a Student</Button>
                        </div>
                    </Card>
                </div>
            );
        }

        const LoginPage = ({ userRole }) => {
          const { login, setPage } = useContext(AppContext);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            const success = login(email, password, userRole);
            if (!success) {
              setError('Invalid email or password. Please try again.');
            } else {
                setError('');
            }
          };

          return (
            <div className="flex-grow flex items-center justify-center p-4">
              <Card className="w-full max-w-md">
                <h2 className="text-3xl font-bold text-center text-white mb-2">
                  {userRole === 'teacher' ? 'Teacher Login' : 'Student Login'}
                </h2>
                <p className="text-center text-gray-400 mb-8">Login to access your dashboard.</p>
                
                <div className="bg-black/20 p-3 rounded-lg mb-6 border border-white/10 text-sm">
                    <p className="text-center font-bold text-gray-300 mb-2">Use these temporary credentials:</p>
                    {userRole === 'teacher' ? (
                        <div>
                            <p><span className="font-semibold text-gray-400">Email:</span> teacher@quizspark.com</p>
                            <p><span className="font-semibold text-gray-400">Password:</span> password</p>
                        </div>
                    ) : (
                         <div>
                            <p><span className="font-semibold text-gray-400">Email:</span> student@quizspark.com</p>
                            <p><span className="font-semibold text-gray-400">Password:</span> password</p>
                        </div>
                    )}
                </div>

                <form onSubmit={handleSubmit} className="space-y-6">
                  <Input 
                    name="email" 
                    type="email" 
                    placeholder="Email Address" 
                    value={email} 
                    onChange={(e) => setEmail(e.target.value)} 
                  />
                  <Input 
                    name="password" 
                    type="password" 
                    placeholder="Password" 
                    value={password} 
                    onChange={(e) => setPassword(e.target.value)} 
                  />
                  {error && <p className="text-red-400 text-center">{error}</p>}
                  <Button type="submit" className="w-full text-lg">Login</Button>
                  <button type="button" onClick={() => setPage('role_selection')} className="w-full text-center text-gray-400 hover:text-white mt-4">
                    &larr; Back to role selection
                  </button>
                </form>
              </Card>
            </div>
          );
        };

        // --- TEACHER PORTAL COMPONENTS ---

        const QuestionEditorCard = ({ q, qIndex, updateQuestion, deleteQuestion }) => {
            
            const handleQuestionTextChange = (e) => {
              const updatedQuestion = { ...q, question_text: e.target.value };
              updateQuestion(qIndex, updatedQuestion);
            };

            const handleOptionTextChange = (oIndex, text) => {
              const newOptions = q.options.map((option, index) => {
                if (index === oIndex) {
                  return { ...option, text: text };
                }
                return option;
              });
              const updatedQuestion = { ...q, options: newOptions };
              updateQuestion(qIndex, updatedQuestion);
            };

            const handleMediaChange = (field, value) => {
                let newMediaType = q.media_type;
                let newMediaUrl = q.media_url;

                if (field === 'type') {
                    newMediaType = value;
                    if (value === 'none') {
                        newMediaUrl = '';
                    }
                } else if (field === 'url') {
                    let url = value;
                    if (q.media_type === 'video') {
                        if (url.includes('youtu.be/')) {
                            url = url.replace('youtu.be/', 'www.youtube.com/embed/');
                        }
                        if (url.includes('watch?v=')) {
                            url = url.replace('watch?v=', 'embed/');
                        }
                        if (url.includes('youtube.com/')) {
                            url = url.replace('youtube.com', 'youtube-nocookie.com');
                        }
                    }
                    newMediaUrl = url;
                }
                
                const updatedQuestion = { ...q, media_type: newMediaType, media_url: newMediaUrl };
                updateQuestion(qIndex, updatedQuestion);
            };

            const setCorrectAnswer = (oIndex) => {
                const newOptions = q.options.map((opt, idx) => ({...opt, is_correct: idx === oIndex }));
                const updatedQuestion = { ...q, options: newOptions };
                updateQuestion(qIndex, updatedQuestion);
            };

            const addOption = () => {
                const newOptions = [...q.options, {id: Date.now(), text: '', is_correct: false}];
                const updatedQuestion = { ...q, options: newOptions };
                updateQuestion(qIndex, updatedQuestion);
            }
            
            const removeOption = (oIndex) => {
                if(q.options.length > 2) {
                    const newOptions = q.options.filter((_, idx) => idx !== oIndex);
                    if (!newOptions.some(opt => opt.is_correct)) {
                        if(newOptions.length > 0) newOptions[0].is_correct = true;
                    }
                    const updatedQuestion = { ...q, options: newOptions };
                    updateQuestion(qIndex, updatedQuestion);
                }
            }
            
            return (
                <Card className="mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-xl font-bold text-white">Question {qIndex + 1}</h4>
                        <Button onClick={() => deleteQuestion(qIndex)} variant="danger" className="p-3"><TrashIcon/></Button>
                    </div>
                    
                    <textarea
                        value={q.question_text}
                        onChange={handleQuestionTextChange}
                        placeholder="Enter question text here..."
                        className="w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 min-h-[100px]"
                    />

                    <div className="mt-4 border-t border-white/10 pt-4">
                        <h5 className="text-lg font-semibold text-gray-300 mb-2">Media (Optional)</h5>
                        <div className="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div className="flex-1 w-full">
                                <label className="text-sm text-gray-400 block mb-1">Media Type</label>
                                <select
                                    value={q.media_type}
                                    onChange={(e) => handleMediaChange('type', e.target.value)}
                                    className="w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-green-400"
                                >
                                    <option value="none">None</option>
                                    <option value="image">Image URL</option>
                                    <option value="video">YouTube URL</option>
                                </select>
                            </div>
                            {q.media_type !== 'none' && (
                                <div className="flex-grow-[2] w-full">
                                    <label className="text-sm text-gray-400 block mb-1">
                                        {q.media_type === 'image' ? 'Image URL' : 'YouTube URL'}
                                    </label>
                                    <Input
                                        value={q.media_url}
                                        onChange={(e) => handleMediaChange('url', e.target.value)}
                                        placeholder={q.media_type === 'image' ? 'https://.../image.png' : 'https://www.youtube.com/watch?v=...'}
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-4">
                        <h5 className="text-lg font-semibold text-gray-300 mb-2">Options</h5>
                        {q.options.map((opt, oIndex) => (
                            <div key={opt.id} className="flex items-center space-x-2 mb-2">
                                <input type="radio" name={`correct_answer_${q.id}`} checked={opt.is_correct} onChange={() => setCorrectAnswer(oIndex)} className="form-radio h-5 w-5 text-green-400 bg-black/20 border-white/30 focus:ring-green-400" />
                                <Input value={opt.text} onChange={(e) => handleOptionTextChange(oIndex, e.target.value)} placeholder={`Option ${oIndex + 1}`} />
                                <Button onClick={() => removeOption(oIndex)} variant="danger" className="p-3" disabled={q.options.length <= 2}>
                                    <TrashIcon />
                                </Button>
                            </div>
                        ))}
                        <Button onClick={addOption} variant="secondary" className="mt-2 text-sm py-2">Add Option</Button>
                    </div>
                </Card>
            );
        };

        const TeacherDashboard = () => {
          const { quizzes, submissions, user, setPage, setActiveQuizId, deleteQuiz } = useContext(AppContext);
          const teacherQuizzes = quizzes.filter(q => q.teacher_id === user.id);
         
          const getQuizStats = (quizId) => {
            const quizSubmissions = submissions.filter(s => s.quiz_id === quizId);
            const quiz = quizzes.find(q => q.id === quizId);
            if (!quiz || quizSubmissions.length === 0) {
                return { takers: 0, average: 'N/A' };
            }
            const totalScore = quizSubmissions.reduce((acc, sub) => acc + sub.score, 0);
            const averageScore = totalScore / quizSubmissions.length;
            const maxScore = quiz.questions.length > 0 ? quiz.questions.length : 1;
            
            return {
                takers: quizSubmissions.length,
                average: `${averageScore.toFixed(1)}/${maxScore}`
            };
          };

          return (
            <div className="container mx-auto py-8">
              <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-8">
                <h2 className="text-3xl md:text-4xl font-bold text-white mb-4 sm:mb-0">My Quizzes</h2>
                <Button onClick={() => { setActiveQuizId(null); setPage('quiz_editor'); }} className="flex items-center justify-center self-start sm:self-auto">
                  <PlusIcon className="mr-2" /> Create New Quiz
                </Button>
              </div>
              {teacherQuizzes.length === 0 ? (
                 <Card className="text-center py-12">
                   <h3 className="text-2xl text-white mb-4">No quizzes found.</h3>
                   <p className="text-gray-400">Click "Create New Quiz" to get started!</p>
                 </Card>
              ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {teacherQuizzes.map(quiz => {
                  const stats = getQuizStats(quiz.id);
                  return (
                    <Card key={quiz.id} className="flex flex-col justify-between hover:shadow-green-400/20 hover:-translate-y-1">
                      <div>
                        <div className="flex justify-between items-start">
                          <h3 className="text-2xl font-bold text-white mb-2">{quiz.title}</h3>
                          <span className={`px-3 py-1 text-xs rounded-full font-semibold ${quiz.status === 'published' ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'}`}>
                            {quiz.status.toUpperCase()}
                          </span>
                        </div>
                        <p className="text-gray-400 mb-4">{quiz.description}</p>
                      </div>
                      <div>
                        <div className="border-t border-white/10 my-4"></div>
                        <div className="flex flex-wrap justify-between gap-y-2 text-gray-300 text-sm">
                          <div className="flex items-center"><BookOpenIcon /> {quiz.questions.length} Questions</div>
                          <div className="flex items-center"><UsersIcon /> {stats.takers} Takers</div>
                          <div className="flex items-center"><ChartBarIcon /> Avg: {stats.average}</div>
                        </div>
                        <div className="border-t border-white/10 my-4"></div>
                        <div className="flex flex-wrap gap-2 mt-4">
                          <Button onClick={() => { setActiveQuizId(quiz.id); setPage('quiz_editor'); }} variant="secondary" className="flex-1 py-2 flex items-center justify-center gap-2"><EditIcon /> Edit</Button>
                          <Button onClick={() => { setActiveQuizId(quiz.id); setPage('quiz_analytics'); }} variant="secondary" className="flex-1 py-2">Analytics</Button>
                          <Button onClick={() => deleteQuiz(quiz.id)} variant="danger" className="p-3"><TrashIcon /></Button>
                        </div>
                      </div>
                    </Card>
                  );
                })}
              </div>
              )}
            </div>
          );
        };

        const QuizEditor = () => {
          const { saveQuiz, quizzes, activeQuizId, setPage, user, setQuizzes } = useContext(AppContext);
          const existingQuiz = activeQuizId ? quizzes.find(q => q.id === activeQuizId) : null;
          const [quiz, setQuiz] = useState(existingQuiz || {
            title: '',
            description: '',
            time_limit: 30,
            status: 'draft',
            teacher_id: user.id,
            questions: [],
          });
          const [error, setError] = useState('');

          const handleQuizChange = (e) => {
            const { name, value } = e.target;
            setQuiz({ ...quiz, [name]: name === 'time_limit' ? Number(value) : value });
          };

          const addQuestion = () => {
            const newQuestion = {
              id: Date.now(),
              question_text: '',
              media_type: 'none',
              media_url: '',
              options: [
                { id: Date.now() + 1, text: '', is_correct: true },
                { id: Date.now() + 2, text: '', is_correct: false },
              ],
            };
            setQuiz({ ...quiz, questions: [...quiz.questions, newQuestion] });
          };
         
          const updateQuestion = (qIndex, updatedQuestion) => {
              const newQuestions = [...quiz.questions];
              newQuestions[qIndex] = updatedQuestion;
              setQuiz({...quiz, questions: newQuestions});
          };
         
          const deleteQuestion = (qIndex) => {
              const newQuestions = quiz.questions.filter((_, index) => index !== qIndex);
              setQuiz({...quiz, questions: newQuestions});
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            
            if (quiz.questions.length > 0 && quiz.questions.some(q => !q.options.some(o => o.is_correct))) {
                setError('Each question must have one correct answer marked.');
                return;
            }
             if (quiz.questions.length > 0 && quiz.questions.some(q => q.question_text.trim() === '' || q.options.some(o => o.text.trim() === ''))) {
              setError('Question and option text cannot be empty.');
              return;
            }
            
            setError('');
            saveQuiz(quiz);
          };
         
          const handlePublish = (e) => {
            e.preventDefault();
            const publishedQuiz = {...quiz, status: 'published'};
            saveQuiz(publishedQuiz);
          }

          return (
            <div className="container mx-auto py-8">
              <h2 className="text-3xl sm:text-4xl font-bold text-white mb-8">{existingQuiz ? 'Edit Quiz' : 'Create New Quiz'}</h2>
              <form onSubmit={handleSubmit}>
                <Card className="mb-6">
                  <h3 className="text-2xl font-bold text-white mb-4">Quiz Details</h3>
                  <div className="space-y-4">
                    <Input name="title" placeholder="Quiz Title" value={quiz.title} onChange={handleQuizChange} />
                    <textarea
                      name="description"
                      placeholder="Quiz Description"
                      value={quiz.description}
                      onChange={handleQuizChange}
                      className="w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 min-h-[120px]"
                    />
                    <div>
                      <label className="block text-gray-300 mb-1">Time Limit (minutes, 0 for no limit)</label>
                      <Input name="time_limit" type="number" value={quiz.time_limit} onChange={handleQuizChange} />
                    </div>
                  </div>
                </Card>

                <div>
                    <h3 className="text-2xl font-bold text-white mb-4">Questions</h3>
                    {quiz.questions.map((q, qIndex) => (
                        <QuestionEditorCard 
                            key={q.id || qIndex} 
                            q={q} 
                            qIndex={qIndex} 
                            updateQuestion={updateQuestion} 
                            deleteQuestion={deleteQuestion}
                        />
                    ))}
                </div>
                
                <Button onClick={addQuestion} variant="secondary" className="mb-8">Add Question</Button>
                
                {error && <p className="bg-red-500/20 border border-red-500/50 text-red-300 p-3 rounded-lg mb-4 text-center">{error}</p>}

                <div className="flex flex-col sm:flex-row justify-end items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                    <Button onClick={() => setPage('teacher_dashboard')} variant="secondary" className="w-full sm:w-auto">Cancel</Button>
                    <Button type="submit" className="w-full sm:w-auto">Save as Draft</Button>
                    <Button onClick={handlePublish} variant="primary" className="w-full sm:w-auto">Save & Publish</Button>
                </div>
              </form>
            </div>
          );
        };

        const StudentResultView = ({ submission, quiz, onBack }) => {
            const student = mockData.users.find(u => u.id === submission.student_id);

            return (
                <Card>
                    <Button onClick={onBack} variant="secondary" className="mb-6">← Back to Analytics</Button>
                    <h3 className="text-xl sm:text-2xl font-bold text-white mb-4">
                        Viewing Submission for: <span className="text-green-400">{student?.name || 'Unknown Student'}</span>
                    </h3>

                    <div className="my-4 p-4 bg-black/20 rounded-lg text-center">
                        <p className="text-gray-400 text-lg">Final Score</p>
                        <p className="text-4xl sm:text-5xl font-bold text-green-400 my-1">
                            {submission.score} <span className="text-2xl sm:text-3xl text-gray-400">/ {quiz.questions.length}</span>
                        </p>
                    </div>

                    <div className="mt-6 space-y-4 text-left">
                        {quiz.questions.map((q, index) => {
                            const userAnswer = submission.answers.find(a => a.question_id === q.id);
                            const userOption = q.options.find(o => o.id === userAnswer?.selected_option_id);
                            const correctOption = q.options.find(o => o.is_correct);
                            const isCorrect = userAnswer?.selected_option_id === correctOption.id;

                            return (
                                <div key={q.id} className="p-3 sm:p-4 rounded-lg bg-black/20 border-l-4" style={{borderColor: isCorrect ? '#4ade80' : '#f87171'}}>
                                   <p className="font-semibold text-gray-300 mb-2">{index + 1}. {q.question_text}</p>
                                   <div className="space-y-1 text-sm">
                                       <p className={`flex items-center ${isCorrect ? 'text-green-300' : 'text-red-300'}`}>
                                          {isCorrect ? <CheckCircleIcon className="h-5 w-5 mr-2"/> : <XCircleIcon className="h-5 w-5 mr-2"/>}
                                          Your Answer: {userOption ? userOption.text : <span className="italic">Not answered</span>}
                                       </p>
                                       {!isCorrect && (
                                            <p className="flex items-center text-gray-400">
                                                <CheckCircleIcon className="h-5 w-5 mr-2 text-green-400 opacity-50"/>
                                                Correct Answer: {correctOption.text}
                                            </p>
                                        )}
                                   </div>
                                </div>
                            )
                        })}
                    </div>
                </Card>
            );
        };

        const QuizAnalytics = () => {
            const { activeQuizId, quizzes, submissions, setPage } = useContext(AppContext);
            const quiz = quizzes.find(q => q.id === activeQuizId);
            const quizSubmissions = submissions.filter(s => s.quiz_id === activeQuizId);
            const [viewingSubmission, setViewingSubmission] = useState(null);
            
            if(!quiz) return <div className="container mx-auto py-8 text-white">Quiz not found. <Button onClick={() => setPage('teacher_dashboard')}>Go Back</Button></div>
            
            const questionAnalytics = quiz.questions.map(question => {
                let correctAnswers = 0;
                quizSubmissions.forEach(sub => {
                    const answer = sub.answers.find(a => a.question_id === question.id);
                    if(answer){
                        const correctOption = question.options.find(o => o.is_correct);
                        if(correctOption && answer.selected_option_id === correctOption.id){
                            correctAnswers++;
                        }
                    }
                });
                const correctPercentage = quizSubmissions.length > 0 ? (correctAnswers / quizSubmissions.length) * 100 : 0;
                return {
                    ...question,
                    correctPercentage: correctPercentage.toFixed(0)
                }
            });

            const formatTime = (start, end) => {
                const diff = new Date(end) - new Date(start);
                const minutes = Math.floor(diff / 60000);
                const seconds = ((diff % 60000) / 1000).toFixed(0);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };

            if (viewingSubmission) {
                return (
                    <div className="container mx-auto py-8">
                        <StudentResultView 
                            submission={viewingSubmission} 
                            quiz={quiz} 
                            onBack={() => setViewingSubmission(null)} 
                        />
                    </div>
                );
            }

            return (
                <div className="container mx-auto py-8">
                    <Button onClick={() => setPage('teacher_dashboard')} variant="secondary" className="mb-8">← Back to Dashboard</Button>
                    <h2 className="text-3xl sm:text-4xl font-bold text-white mb-2">{quiz.title} - Analytics</h2>
                    <p className="text-gray-400 mb-8">{quiz.description}</p>
                    
                    <Card className="mb-8">
                        <h3 className="text-2xl font-bold text-white mb-4">Student Submissions</h3>
                        <div className="overflow-x-auto rounded-lg">
                            <table className="w-full min-w-[600px] text-left">
                                <thead>
                                    <tr className="bg-black/30 border-b border-white/20 text-gray-400">
                                        <th className="p-3">Student</th>
                                        <th className="p-3">Score</th>
                                        <th className="p-3">Time Taken</th>
                                        <th className="p-3">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {quizSubmissions.map(sub => {
                                        const student = mockData.users.find(u => u.id === sub.student_id);
                                        return (
                                        <tr key={sub.id} className="border-b border-white/10 hover:bg-white/5 cursor-pointer" onClick={() => setViewingSubmission(sub)}>
                                            <td className="p-3">{student ? student.name : 'Unknown'}</td>
                                            <td className="p-3">{sub.score} / {quiz.questions.length}</td>
                                            <td className="p-3">{formatTime(sub.start_time, sub.end_time)}</td>
                                            <td className="p-3">{new Date(sub.end_time).toLocaleDateString()}</td>
                                        </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                     <Card>
                        <h3 className="text-2xl font-bold text-white mb-4">Question Performance</h3>
                         {questionAnalytics.map((q, index) => (
                            <div key={q.id} className="mb-4 p-4 bg-black/20 rounded-lg">
                                <p className="font-semibold text-gray-200">{index+1}. {q.question_text}</p>
                                <div className="flex items-center mt-2">
                                   <div className="w-full bg-white/20 rounded-full h-2 sm:h-4 mr-4">
                                       <div className="bg-green-400 h-2 sm:h-4 rounded-full" style={{width: `${q.correctPercentage}%`}}></div>
                                   </div>
                                   <span className="text-base sm:text-lg font-bold text-green-300">{q.correctPercentage}%</span>
                                </div>
                            </div>
                         ))}
                    </Card>
                </div>
            )
        }

        // --- STUDENT PORTAL COMPONENTS ---

        const StudentDashboard = () => {
          const { quizzes, user, submissions, startQuiz, viewPastResult } = useContext(AppContext);

          const studentSubmissions = useMemo(() => 
            submissions.filter(s => s.student_id === user.id), 
            [submissions, user.id]
          );

          const completedQuizIds = useMemo(() => 
            new Set(studentSubmissions.map(s => s.quiz_id)), 
            [studentSubmissions]
          );

          const availableQuizzes = useMemo(() =>
            quizzes.filter(q => q.status === 'published' && !completedQuizIds.has(q.id)),
            [quizzes, completedQuizIds]
          );
          
          const pastQuizzes = useMemo(() =>
            studentSubmissions.map(submission => {
                const quiz = quizzes.find(q => q.id === submission.quiz_id);
                return { ...quiz, submission };
            }).filter(item => item.id), // Filter out cases where quiz might not be found
            [studentSubmissions, quizzes]
          );

          return (
            <div className="container mx-auto py-8">
              <h2 className="text-3xl md:text-4xl font-bold text-white mb-8">Available Quizzes</h2>
              {availableQuizzes.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                  {availableQuizzes.map(quiz => (
                    <Card key={quiz.id} className="flex flex-col justify-between">
                      <div>
                        <h3 className="text-2xl font-bold text-white mb-2">{quiz.title}</h3>
                        <p className="text-gray-400 mb-4">{quiz.description}</p>
                      </div>
                      <div>
                        <div className="border-t border-white/10 my-4"></div>
                        <div className="flex flex-wrap justify-between gap-y-2 text-gray-300 text-sm">
                          <div className="flex items-center"><BookOpenIcon /> {quiz.questions.length} Questions</div>
                          <div className="flex items-center"><ClockIcon /> {quiz.time_limit > 0 ? `${quiz.time_limit} Minutes` : 'No time limit'}</div>
                        </div>
                        <div className="mt-6">
                          <Button onClick={() => startQuiz(quiz.id)} className="w-full flex items-center justify-center">
                            Start Quiz
                            <ArrowRightIcon/>
                          </Button>
                        </div>
                      </div>
                    </Card>
                  ))}
                </div>
              ) : (
                <Card className="text-center py-12">
                   <h3 className="text-2xl text-white mb-4">No Available Quizzes</h3>
                   <p className="text-gray-400">Check back later for new quizzes!</p>
                </Card>
              )}

              <div className="mt-16">
                <h2 className="text-3xl md:text-4xl font-bold text-white mb-8">Past Quizzes</h2>
                {pastQuizzes.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                        {pastQuizzes.map(quiz => (
                            <Card key={quiz.submission.id} className="flex flex-col justify-between">
                                <div>
                                    <h3 className="text-2xl font-bold text-white mb-2">{quiz.title}</h3>
                                     <p className="text-gray-400 mb-4">{quiz.description}</p>
                                </div>
                                <div>
                                    <div className="border-t border-white/10 my-4"></div>
                                     <div className="text-center p-3 sm:p-4 rounded-lg bg-green-500/10 border border-green-500/20">
                                        <p className="font-bold text-base sm:text-lg text-green-300">Completed!</p>
                                        <p className="text-lg sm:text-xl font-bold text-white">Your Score: {quiz.submission.score}/{quiz.questions.length}</p>
                                    </div>
                                    <div className="mt-6">
                                        <Button onClick={() => viewPastResult(quiz.submission.id)} variant="secondary" className="w-full flex items-center justify-center">
                                        View Results
                                        </Button>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                ) : (
                     <Card className="text-center py-12">
                       <h3 className="text-2xl text-white mb-4">No Past Quizzes</h3>
                       <p className="text-gray-400">Your completed quizzes will appear here.</p>
                    </Card>
                )}
              </div>
            </div>
          );
        };

        const QuizTaker = () => {
            const { activeQuizId, quizzes, submitQuiz, activeSubmissionId } = useContext(AppContext);
            const quiz = quizzes.find(q => q.id === activeQuizId);
            
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState([]);
            const [timeLeft, setTimeLeft] = useState(quiz.time_limit * 60);
            const [isOverviewOpen, setIsOverviewOpen] = useState(false);

            const handleSubmit = () => {
                submitQuiz(activeSubmissionId, answers);
            }
            
            useEffect(() => {
                if (quiz.time_limit > 0) {
                    const timer = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                submitQuiz(activeSubmissionId, answers);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [quiz.time_limit, submitQuiz, activeSubmissionId, answers]);

            const selectAnswer = (questionId, optionId) => {
                const otherAnswers = answers.filter(a => a.question_id !== questionId);
                setAnswers([...otherAnswers, { question_id: questionId, selected_option_id: optionId }]);
            };
            
            if(!quiz) return <div>Loading quiz...</div>;

            const currentQuestion = quiz.questions[currentQuestionIndex];
            const selectedOption = answers.find(a => a.question_id === currentQuestion.id)?.selected_option_id;
            const hasMedia = currentQuestion.media_type !== 'none';

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            return (
                <div className="flex flex-col h-screen">
                    <style>{`
                        .custom-scrollbar::-webkit-scrollbar {
                            width: 12px;
                        }
                        .custom-scrollbar::-webkit-scrollbar-track {
                            background: #3a3d40;
                            border-radius: 10px;
                        }
                        .custom-scrollbar::-webkit-scrollbar-thumb {
                            background-color: #ffffff;
                            border-radius: 10px;
                            border: 3px solid #3a3d40;
                        }
                          .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                            background-color: #f0f0f0;
                        }
                    `}</style>
                    <div className="p-2 sm:p-3 bg-black/20 backdrop-blur-lg shrink-0">
                        <div className="flex justify-between items-center">
                             <h2 className="text-base sm:text-lg md:text-xl font-bold text-white truncate pr-4">{quiz.title}</h2>
                            {quiz.time_limit > 0 && 
                                <div className="bg-black/30 text-white px-2 py-1 sm:px-3 rounded-lg font-mono text-sm sm:text-base md:text-lg shadow-lg flex items-center">
                                    <ClockIcon /> {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
                                </div>
                            }
                        </div>
                    </div>

                    <div className="flex-grow p-2 sm:p-4 flex flex-col justify-center overflow-hidden pb-14 sm:pb-0">
                        <div className="w-full h-full mx-auto lg:max-w-6xl flex flex-col">
                            <Card className="flex-grow flex flex-col overflow-hidden !p-3 sm:!p-6 w-full">
                                <h3 className="text-sm sm:text-base text-gray-200 mb-2 sm:mb-3 shrink-0">Question {currentQuestionIndex + 1} of {quiz.questions.length}</h3>
                                
                                <div className={`flex-grow overflow-y-auto custom-scrollbar lg:grid ${hasMedia ? 'lg:grid-cols-2 lg:gap-8' : 'lg:grid-cols-1'} items-center`}>
                                   {hasMedia && (
                                        <div className="mb-4 lg:mb-0">
                                            {currentQuestion.media_type === 'image' && <img src={currentQuestion.media_url} alt="Question visual aid" className="max-w-full w-full mx-auto rounded-lg"/>}
                                            {currentQuestion.media_type === 'video' && (
                                                <div className="aspect-video">
                                                   <iframe className="w-full h-full rounded-lg" src={currentQuestion.media_url} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                                                </div>
                                            )}
                                        </div>
                                   )}

                                    <div className={`w-full ${hasMedia ? 'lg:max-w-lg lg:mx-auto' : 'max-w-3xl mx-auto'}`}>
                                        <p className="text-white text-lg md:text-xl mb-4">{currentQuestion.question_text}</p>
                                        <div className="space-y-3">
                                            {currentQuestion.options.map(option => (
                                               <label key={option.id} className={`flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors ${selectedOption === option.id ? 'bg-green-500/30 border-green-400' : 'bg-black/20 border-white/20 hover:border-green-400'}`}>
                                                   <input 
                                                       type="radio"
                                                       name={`question_${currentQuestion.id}`}
                                                       checked={selectedOption === option.id}
                                                       onChange={() => selectAnswer(currentQuestion.id, option.id)}
                                                       className="h-5 w-5 text-green-400 bg-black/20 border-white/30 focus:ring-green-400 mr-3"
                                                   />
                                                   <span className="text-white text-base md:text-lg">{option.text}</span>
                                               </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </Card>

                            <div className="flex justify-between mt-4 sm:mt-6 sm:mb-4 shrink-0">
                                <Button variant="secondary" onClick={() => setCurrentQuestionIndex(i => i - 1)} disabled={currentQuestionIndex === 0}>Previous</Button>
                                {currentQuestionIndex === quiz.questions.length -1 ? (
                                     <Button onClick={handleSubmit}>Submit Quiz</Button>
                                ): (
                                     <Button onClick={() => setCurrentQuestionIndex(i => i + 1)}>Next</Button>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Desktop Footer */}
                     <div className="hidden sm:flex w-full bg-black/30 backdrop-blur-lg p-4 items-center justify-between">
                        <h4 className="text-white font-bold text-base">Questions Overview</h4>
                        <div className="flex flex-wrap justify-center gap-2">
                            {quiz.questions.map((q, index) => {
                                const isAnswered = answers.some(a => a.question_id === q.id);
                                return (
                                    <button 
                                        key={q.id}
                                        onClick={() => setCurrentQuestionIndex(index)}
                                        className={`h-10 w-10 rounded-lg flex items-center justify-center font-bold transition-colors text-sm ${
                                            index === currentQuestionIndex ? 'bg-green-400 text-green-950' : 
                                            isAnswered ? 'bg-white/20 text-white' : 'bg-black/20 text-gray-400'
                                        }`}
                                    >{index+1}</button>
                                )
                            })}
                        </div>
                        <Button onClick={handleSubmit}>Submit</Button>
                    </div>
                    
                    {/* Mobile Collapsible Footer */}
                    <div className="sm:hidden fixed bottom-0 left-0 right-0 bg-black/30 backdrop-blur-lg shadow-2xl rounded-t-lg transition-all duration-300 ease-in-out">
                        <div className="flex justify-between items-center p-3 cursor-pointer" onClick={() => setIsOverviewOpen(!isOverviewOpen)}>
                            <h4 className="text-white font-bold text-base">Questions Overview</h4>
                            <ChevronUpIcon className={`w-6 h-6 text-white transition-transform duration-300 ${isOverviewOpen ? 'rotate-180' : ''}`} />
                        </div>
                        <div className={`transition-[max-height] duration-300 ease-in-out overflow-y-auto ${isOverviewOpen ? 'max-h-48' : 'max-h-0'}`}>
                            <div className="p-2 pt-0">
                                <div className="grid grid-cols-8 gap-1">
                                    {quiz.questions.map((q, index) => {
                                        const isAnswered = answers.some(a => a.question_id === q.id);
                                        return (
                                            <button 
                                                key={q.id}
                                                onClick={() => setCurrentQuestionIndex(index)}
                                                className={`h-8 w-8 rounded flex items-center justify-center font-bold transition-colors text-xs ${
                                                    index === currentQuestionIndex ? 'bg-green-400 text-green-950' : 
                                                    isAnswered ? 'bg-white/20 text-white' : 'bg-black/20 text-gray-400'
                                                }`}
                                            >{index+1}</button>
                                        )
                                    })}
                                </div>
                                <Button onClick={handleSubmit} className="w-full mt-3">Submit</Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const QuizResults = () => {
            const { activeSubmissionId, submissions, quizzes, setPage } = useContext(AppContext);
            
            if(!activeSubmissionId) {
                useEffect(() => {
                    setPage('student_dashboard');
                }, [setPage]);
                return null;
            }

            const submission = submissions.find(s => s.id === activeSubmissionId);
            
            if(!submission) return <div>Loading results...</div>
            
            const quiz = quizzes.find(q => q.id === submission.quiz_id);
            const percentage = ((submission.score / quiz.questions.length) * 100).toFixed(0);

            return (
                <div className="flex-grow flex items-center justify-center p-4">
                    <Card className="w-full max-w-2xl text-center">
                        <h2 className="text-2xl sm:text-3xl font-bold text-white mb-4">Quiz Results</h2>
                        <h3 className="text-xl sm:text-2xl text-gray-300 mb-6">{quiz.title}</h3>

                        <div className="my-6 sm:my-8">
                            <p className="text-gray-400 text-lg">Your Score</p>
                            <p className="text-5xl sm:text-7xl font-bold text-green-400 my-2">{submission.score} <span className="text-3xl sm:text-5xl text-gray-400">/ {quiz.questions.length}</span></p>
                            <p className="text-2xl sm:text-3xl font-semibold text-white">{percentage}%</p>
                        </div>
                        
                        <div className="my-6 sm:my-8 space-y-4 text-left">
                            {quiz.questions.map((q, index) => {
                                const userAnswer = submission.answers.find(a => a.question_id === q.id);
                                const userOption = q.options.find(o => o.id === userAnswer?.selected_option_id);
                                const correctOption = q.options.find(o => o.is_correct);
                                const isCorrect = userAnswer?.selected_option_id === correctOption.id;

                                return (
                                    <div key={q.id} className="p-3 sm:p-4 rounded-lg bg-black/20 border-l-4" style={{borderColor: isCorrect ? '#4ade80' : '#f87171'}}>
                                       <p className="font-semibold text-gray-300 mb-2">{index + 1}. {q.question_text}</p>
                                       <div className="space-y-1 text-sm">
                                           <p className={`flex items-center ${isCorrect ? 'text-green-300' : 'text-red-300'}`}>
                                              {isCorrect ? <CheckCircleIcon className="h-5 w-5 mr-2"/> : <XCircleIcon className="h-5 w-5 mr-2"/>}
                                              Your Answer: {userOption ? userOption.text : <span className="italic">Not answered</span>}
                                           </p>
                                           {!isCorrect && (
                                                <p className="flex items-center text-gray-400">
                                                    <CheckCircleIcon className="h-5 w-5 mr-2 text-green-400 opacity-50"/>
                                                    Correct Answer: {correctOption.text}
                                                </p>
                                            )}
                                       </div>
                                    </div>
                                )
                            })}
                        </div>

                        <Button onClick={() => setPage('student_dashboard')} className="mt-6">Back to Dashboard</Button>
                    </Card>
                </div>
            );
        };


        // --- MAIN APP COMPONENT ---

        const Background = () => (
            <div className="fixed inset-0 -z-10 overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-full bg-gray-950">
                    <div className="absolute top-[-10%] left-[10%] w-[40rem] h-[40rem] bg-green-500/20 rounded-full filter blur-3xl opacity-40 animate-blob"></div>
                    <div className="absolute bottom-[-10%] right-[5%] w-[40rem] h-[40rem] bg-indigo-500/20 rounded-full filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>
                    <div className="absolute top-[5%] right-[25%] w-[30rem] h-[30rem] bg-pink-500/20 rounded-full filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
                </div>
                <style>{`
                    @keyframes blob {
                        0% { transform: translate(0px, 0px) scale(1); }
                        33% { transform: translate(30px, -50px) scale(1.1); }
                        66% { transform: translate(-20px, 20px) scale(0.9); }
                        100% { transform: translate(0px, 0px) scale(1); }
                    }
                    .animation-delay-2000 { animation-delay: 2s; }
                    .animation-delay-4000 { animation-delay: 4s; }
                `}</style>
            </div>
        );


        function App() {
          return (
            <AppProvider>
              <MainContent />
            </AppProvider>
          );
        }

        const MainContent = () => {
          const { page } = useContext(AppContext);

          const renderPage = () => {
            switch (page) {
              case 'role_selection':
                return <RoleSelectionPage />;
              case 'login_teacher':
                return <LoginPage userRole="teacher" />;
              case 'login_student':
                return <LoginPage userRole="student" />;
              case 'teacher_dashboard':
                return <TeacherDashboard />;
              case 'quiz_editor':
                return <QuizEditor />;
              case 'quiz_analytics':
                return <QuizAnalytics/>;
              case 'student_dashboard':
                return <StudentDashboard />;
              case 'quiz_taker':
                return <QuizTaker />;
              case 'quiz_results':
                return <QuizResults />;
              default:
                return <RoleSelectionPage />;
            }
          };

          return (
            <div className="bg-gray-950 text-white font-sans min-h-screen flex flex-col relative isolate">
              <Background />
              {page !== 'quiz_taker' && <Header />}
              <main className={`flex-grow ${page !== 'quiz_taker' ? 'p-4 sm:p-8' : ''} ${page === 'quiz_taker' ? 'flex flex-col' : ''}`}>
                {renderPage()}
              </main>
            </div>
          );
        };
        
        // --- Render the App to the DOM ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
